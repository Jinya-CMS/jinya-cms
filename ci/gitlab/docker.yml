build-test-image:
  extends:
    - .build-image
  variables:
    PACKAGE_VERSION: $LATEST_NEXT_MINOR
    TRACK: $ALPHA_TRACK
    KANIKO_FLAGS: --no-push
  rules:
    - if: $CI_COMMIT_REF_PROTECTED == 'false'

build-next-minor-image:
  extends:
    - .build-image
  variables:
    PACKAGE_VERSION: $LATEST_NEXT_MINOR
    TRACK: $ALPHA_TRACK
  rules:
    - if: $CI_COMMIT_BRANCH == $LATEST_NEXT_MINOR_BRANCH

build-next-major-image:
  extends:
    - .build-image
  variables:
    PACKAGE_VERSION: $LATEST_NEXT_MAJOR
    TRACK: $ALPHA_TRACK
  rules:
    - if: $CI_COMMIT_BRANCH == $LATEST_NEXT_MAJOR_BRANCH

build-beta-image:
  extends:
    - .build-image
  variables:
    PACKAGE_VERSION: $LATEST_BETA
    TRACK: $BETA_TRACK
  rules:
    - if: $CI_COMMIT_BRANCH == $LATEST_BETA_BRANCH

build-release-image-latest-gitlab:
  extends:
    - .build-image
  variables:
    TAG_VERSION: latest
    PACKAGE_VERSION: $LATEST
    TRACK: $RELEASE_TRACK
  rules:
    - if: $CI_COMMIT_TAG

build-release-image-tagged-gitlab:
  extends:
    - .build-image
  variables:
    PACKAGE_VERSION: $LATEST
    TRACK: $RELEASE_TRACK
  rules:
    - if: $CI_COMMIT_TAG

build-release-image-latest-dockerhub:
  extends:
    - .build-image
  variables:
    CI_REGISTRY_IMAGE: jinyacms/jinya-cms
    TAG_VERSION: latest
    PACKAGE_VERSION: $LATEST
    TRACK: $RELEASE_TRACK
  rules:
    - if: $CI_COMMIT_TAG

build-release-image-tagged-dockerhub:
  extends:
    - .build-image
  variables:
    CI_REGISTRY_IMAGE: jinyacms/jinya-cms
    PACKAGE_VERSION: $LATEST
    TRACK: $RELEASE_TRACK
  rules:
    - if: $CI_COMMIT_TAG

deploy-next-minor-image:
  extends:
    - .deploy-image
  variables:
    IMAGE_TAG_VERSION: $LATEST_NEXT_MINOR
  rules:
    - if: $CI_COMMIT_BRANCH == $LATEST_NEXT_MINOR_BRANCH

deploy-next-major-image:
  extends:
    - .deploy-image
  variables:
    IMAGE_TAG_VERSION: $LATEST_NEXT_MAJOR
  rules:
    - if: $CI_COMMIT_BRANCH == $LATEST_NEXT_MAJOR_BRANCH

deploy-beta-image:
  extends:
    - .deploy-image
  variables:
    IMAGE_TAG_VERSION: $LATEST_BETA
  rules:
    - if: $CI_COMMIT_BRANCH == $LATEST_BETA_BRANCH

deploy-release-image:
  extends:
    - .deploy-image
  parallel:
    matrix:
      # registry tagged
      - IMAGE_TAG_VERSION: $LATEST
      # registry tagged apache
      - IMAGE_TAG_VERSION: $LATEST
        SUFFIX: -apache
      # registry tagged cli
      - IMAGE_TAG_VERSION: $LATEST
        SUFFIX: -cli
      # registry latest
      - IMAGE_TAG_VERSION: latest
      # registry latest apache
      - IMAGE_TAG_VERSION: latest
        SUFFIX: -apache
      # registry latest cli
      - IMAGE_TAG_VERSION: latest
        SUFFIX: -cli
      # docker hub tagged
      - IMAGE_TAG_VERSION: $LATEST
        CI_REGISTRY_IMAGE: jinyacms/jinya-cms
        CI_REGISTRY_USER: $DOCKERHUB_USERNAME
        CI_REGISTRY_PASSWORD: $DOCKERHUB_PASSWORD
      # docker hub tagged apache
      - IMAGE_TAG_VERSION: $LATEST
        CI_REGISTRY_IMAGE: jinyacms/jinya-cms
        CI_REGISTRY_USER: $DOCKERHUB_USERNAME
        CI_REGISTRY_PASSWORD: $DOCKERHUB_PASSWORD
        SUFFIX: -apache
      # docker hub tagged cli
      - IMAGE_TAG_VERSION: $LATEST
        CI_REGISTRY_IMAGE: jinyacms/jinya-cms
        CI_REGISTRY_USER: $DOCKERHUB_USERNAME
        CI_REGISTRY_PASSWORD: $DOCKERHUB_PASSWORD
        SUFFIX: -cli
      # docker hub latest
      - IMAGE_TAG_VERSION: latest
        CI_REGISTRY_IMAGE: jinyacms/jinya-cms
        CI_REGISTRY_USER: $DOCKERHUB_USERNAME
        CI_REGISTRY_PASSWORD: $DOCKERHUB_PASSWORD
      # docker hub latest apache
      - IMAGE_TAG_VERSION: latest
        CI_REGISTRY_IMAGE: jinyacms/jinya-cms
        CI_REGISTRY_USER: $DOCKERHUB_USERNAME
        CI_REGISTRY_PASSWORD: $DOCKERHUB_PASSWORD
        SUFFIX: -apache
      # docker hub latest cli
      - IMAGE_TAG_VERSION: latest
        CI_REGISTRY_IMAGE: jinyacms/jinya-cms
        CI_REGISTRY_USER: $DOCKERHUB_USERNAME
        CI_REGISTRY_PASSWORD: $DOCKERHUB_PASSWORD
        SUFFIX: -cli
  rules:
    - if: $CI_COMMIT_TAG

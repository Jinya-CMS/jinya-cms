build-test-image:
  extends:
    - .build-image
  variables:
    PACKAGE_VERSION: $LATEST_NEXT_MINOR
    TRACK: $ALPHA_TRACK
    KANIKO_FLAGS: --no-push
  rules:
    - if: $CI_COMMIT_REF_PROTECTED == 'false'

build-next-minor-image:
  extends:
    - .build-image
  variables:
    PACKAGE_VERSION: $LATEST_NEXT_MINOR
    TRACK: $ALPHA_TRACK
  rules:
    - if: $CI_COMMIT_BRANCH == $LATEST_NEXT_MINOR_BRANCH

build-next-major-image:
  extends:
    - .build-image
  variables:
    PACKAGE_VERSION: $LATEST_NEXT_MAJOR
    TRACK: $ALPHA_TRACK
  rules:
    - if: $CI_COMMIT_BRANCH == $LATEST_NEXT_MAJOR_BRANCH

build-beta-image:
  extends:
    - .build-image
  variables:
    PACKAGE_VERSION: $LATEST_BETA
    TRACK: $BETA_TRACK
  rules:
    - if: $CI_COMMIT_BRANCH == $LATEST_BETA_BRANCH

build-release-image:
  extends:
    - .build-image
  parallel:
    matrix:
      - TAG_VERSION:
          - latest
          - $PACKAGE_VERSION
        REGISTRY_IMAGE:
          - jinyacms/jinya-cms
          - $CI_REGISTRY_IMAGE
  variables:
    PACKAGE_VERSION: $LATEST
    TRACK: $RELEASE_TRACK
  rules:
    - if: $CI_COMMIT_TAG

deploy-next-minor-image:
  extends:
    - .deploy-image
  variables:
    IMAGE_TAG_VERSION: $LATEST_NEXT_MINOR
  rules:
    - if: $CI_COMMIT_BRANCH == $LATEST_NEXT_MINOR_BRANCH

deploy-next-major-image:
  extends:
    - .deploy-image
  variables:
    IMAGE_TAG_VERSION: $LATEST_NEXT_MAJOR
  rules:
    - if: $CI_COMMIT_BRANCH == $LATEST_NEXT_MAJOR_BRANCH

deploy-beta-image:
  extends:
    - .deploy-image
  variables:
    IMAGE_TAG_VERSION: $LATEST_BETA
  rules:
    - if: $CI_COMMIT_BRANCH == $LATEST_BETA_BRANCH

deploy-release-image:
  extends:
    - .deploy-image
  parallel:
    matrix:
      - IMAGE_TAG_VERSION:
          - $LATEST
          - latest
        SUFFIX:
          - ""
          - -apache
          - -cli
        REGISTRY_IMAGE:
          - jinyacms/jinya-cms
          - $CI_REGISTRY_IMAGE
        REGISTRY_USER:
          - $CI_REGISTRY_USER
          - $DOCKERHUB_USERNAME
        REGISTRY_PASSWORD:
          - $CI_REGISTRY_PASSWORD
          - $DOCKERHUB_PASSWORD
  rules:
    - if: $CI_COMMIT_TAG
